generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  OWNER
  ADMIN
  ACCOUNTANT
  VIEWER
}

enum AccountStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PIX
  BOLETO
  CHECK
  OTHER
}

enum CategoryType {
  PAYABLE
  RECEIVABLE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// ==================== MODELS ====================

model Organization {
  id        String   @id @default(uuid())
  name      String
  document  String?  @unique // CNPJ
  email     String?
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users       User[]
  customers   Customer[]
  vendors     Vendor[]
  categories  Category[]
  tags        Tag[]
  payables    Payable[]
  receivables Receivable[]
  payments    Payment[]
  auditLogs   AuditLog[]

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String
  password       String
  name           String
  role           UserRole @default(VIEWER)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs    AuditLog[]

  @@unique([organizationId, email])
  @@map("users")
}

model Customer {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  document       String?  // CPF or CNPJ
  email          String?
  phone          String?
  address        String?
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  receivables  Receivable[]

  @@map("customers")
}

model Vendor {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  document       String?  // CPF or CNPJ
  email          String?
  phone          String?
  address        String?
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payables     Payable[]

  @@map("vendors")
}

model Category {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  name           String
  type           CategoryType
  color          String?      @default("#6B7280") // Tailwind gray-500
  description    String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payables     Payable[]
  receivables  Receivable[]

  @@unique([organizationId, name, type])
  @@map("categories")
}

model Tag {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  color          String?  @default("#3B82F6") // Tailwind blue-500
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payables     PayableTag[]
  receivables  ReceivableTag[]

  @@unique([organizationId, name])
  @@map("tags")
}

model Payable {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  vendorId       String        @map("vendor_id")
  categoryId     String?       @map("category_id")
  description    String
  amount         Decimal       @db.Decimal(15, 2)
  paidAmount     Decimal       @default(0) @map("paid_amount") @db.Decimal(15, 2)
  dueDate        DateTime      @map("due_date") @db.Date
  paymentMethod  PaymentMethod @map("payment_method")
  status         AccountStatus @default(PENDING)
  notes          String?
  documentNumber String?       @map("document_number") // Invoice number, etc.
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor       Vendor                @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  category     Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags         PayableTag[]
  allocations  PaymentAllocation[]

  @@map("payables")
}

model Receivable {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  customerId     String        @map("customer_id")
  categoryId     String?       @map("category_id")
  description    String
  amount         Decimal       @db.Decimal(15, 2)
  paidAmount     Decimal       @default(0) @map("paid_amount") @db.Decimal(15, 2)
  dueDate        DateTime      @map("due_date") @db.Date
  paymentMethod  PaymentMethod @map("payment_method")
  status         AccountStatus @default(PENDING)
  notes          String?
  documentNumber String?       @map("document_number") // Invoice number, etc.
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer              @relation(fields: [customerId], references: [id], onDelete: Cascade)
  category     Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags         ReceivableTag[]
  allocations  PaymentAllocation[]

  @@map("receivables")
}

model PayableTag {
  payableId String @map("payable_id")
  tagId     String @map("tag_id")

  payable Payable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([payableId, tagId])
  @@map("payable_tags")
}

model ReceivableTag {
  receivableId String @map("receivable_id")
  tagId        String @map("tag_id")

  receivable Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  tag        Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([receivableId, tagId])
  @@map("receivable_tags")
}

model Payment {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  amount         Decimal       @db.Decimal(15, 2)
  paymentDate    DateTime      @map("payment_date") @db.Date
  paymentMethod  PaymentMethod @map("payment_method")
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  allocations  PaymentAllocation[]

  @@map("payments")
}

model PaymentAllocation {
  id           String  @id @default(uuid())
  paymentId    String  @map("payment_id")
  payableId    String? @map("payable_id")
  receivableId String? @map("receivable_id")
  amount       Decimal @db.Decimal(15, 2)

  // Relations
  payment    Payment     @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  payable    Payable?    @relation(fields: [payableId], references: [id], onDelete: Cascade)
  receivable Receivable? @relation(fields: [receivableId], references: [id], onDelete: Cascade)

  @@map("payment_allocations")
}

model AuditLog {
  id             String      @id @default(uuid())
  organizationId String      @map("organization_id")
  userId         String?     @map("user_id")
  entity         String      // 'payable', 'receivable', 'payment', etc.
  entityId       String      @map("entity_id")
  action         AuditAction
  oldData        Json?       @map("old_data")
  newData        Json?       @map("new_data")
  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
