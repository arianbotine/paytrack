generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  OWNER
  ADMIN
  ACCOUNTANT
  VIEWER
}

enum AccountStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PIX
  BOLETO
  CHECK
  ACCOUNT_DEBIT
  OTHER
}

enum CategoryType {
  PAYABLE
  RECEIVABLE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// ==================== MODELS ====================

model Organization {
  id        String   @id @default(uuid())
  name      String
  document  String?  @unique // CNPJ
  email     String?
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users                 UserOrganization[]
  customers             Customer[]
  vendors               Vendor[]
  categories            Category[]
  tags                  Tag[]
  payables              Payable[]
  receivables           Receivable[]
  payableInstallments   PayableInstallment[]
  receivableInstallments ReceivableInstallment[]
  payments              Payment[]
  auditLogs             AuditLog[]

  @@map("organizations")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  isSystemAdmin Boolean   @default(false) @map("is_system_admin")
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  organizations UserOrganization[]
  auditLogs     AuditLog[]

  @@map("users")
}

model UserOrganization {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  role           UserRole @default(VIEWER)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, isActive])
  @@map("user_organizations")
}

// Devedor (mant√©m nome "Customer" no banco por compatibilidade)
model Customer {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  document       String?  // CPF ou CNPJ
  email          String?
  phone          String?
  address        String?
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  receivables  Receivable[]

  @@index([organizationId])
  @@map("customers")
}

model Vendor {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  document       String?  // CPF or CNPJ
  email          String?
  phone          String?
  address        String?
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payables     Payable[]

  @@index([organizationId])
  @@map("vendors")
}

model Category {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  name           String
  type           CategoryType
  color          String?      @default("#6B7280") // Tailwind gray-500
  description    String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payables     Payable[]
  receivables  Receivable[]

  @@unique([organizationId, name, type])
  @@index([organizationId])
  @@map("categories")
}

model Tag {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  color          String?  @default("#3B82F6") // Tailwind blue-500
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization           Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payables               PayableTag[]
  receivables            ReceivableTag[]
  payableInstallments    PayableInstallmentTag[]
  receivableInstallments ReceivableInstallmentTag[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("tags")
}

model Payable {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  vendorId       String        @map("vendor_id")
  categoryId     String?       @map("category_id")
  amount         Decimal       @db.Decimal(15, 2)
  paidAmount     Decimal       @default(0) @map("paid_amount") @db.Decimal(15, 2)
  status         AccountStatus @default(PENDING)
  notes          String?

  // Installment metadata
  totalInstallments Int @default(1) @map("total_installments")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor       Vendor                @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  category     Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags         PayableTag[]
  installments PayableInstallment[]

  @@index([organizationId, status])
  @@index([vendorId])
  @@index([categoryId])
  @@index([organizationId, categoryId])
  @@map("payables")
}

model PayableInstallment {
  id                String        @id @default(uuid())
  payableId         String        @map("payable_id")
  organizationId    String        @map("organization_id")
  installmentNumber Int           @map("installment_number")
  totalInstallments Int           @map("total_installments")
  amount            Decimal       @db.Decimal(15, 2)
  paidAmount        Decimal       @default(0) @map("paid_amount") @db.Decimal(15, 2)
  dueDate           DateTime      @map("due_date") @db.Date
  status            AccountStatus @default(PENDING)
  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  payable      Payable                   @relation(fields: [payableId], references: [id], onDelete: Cascade)
  organization Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  allocations  PaymentAllocation[]
  tags         PayableInstallmentTag[]

  @@index([payableId, installmentNumber])
  @@index([organizationId, status, dueDate])
  @@index([organizationId, dueDate])
  @@index([payableId, status, dueDate])
  @@map("payable_installments")
}

model Receivable {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  customerId     String        @map("customer_id")
  categoryId     String?       @map("category_id")
  amount         Decimal       @db.Decimal(15, 2)
  receivedAmount Decimal       @default(0) @map("received_amount") @db.Decimal(15, 2)
  status         AccountStatus @default(PENDING)
  notes          String?

  // Installment metadata
  totalInstallments Int @default(1) @map("total_installments")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer                @relation(fields: [customerId], references: [id], onDelete: Cascade)
  category     Category?               @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags         ReceivableTag[]
  installments ReceivableInstallment[]

  @@index([organizationId, status])
  @@index([customerId])
  @@index([categoryId])
  @@index([organizationId, categoryId])
  @@map("receivables")
}

model ReceivableInstallment {
  id                String        @id @default(uuid())
  receivableId      String        @map("receivable_id")
  organizationId    String        @map("organization_id")
  installmentNumber Int           @map("installment_number")
  totalInstallments Int           @map("total_installments")
  amount            Decimal       @db.Decimal(15, 2)
  receivedAmount    Decimal       @default(0) @map("received_amount") @db.Decimal(15, 2)
  dueDate           DateTime      @map("due_date") @db.Date
  status            AccountStatus @default(PENDING)
  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  receivable   Receivable                 @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  organization Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  allocations  PaymentAllocation[]
  tags         ReceivableInstallmentTag[]

  @@index([receivableId, installmentNumber])
  @@index([organizationId, status, dueDate])
  @@index([organizationId, dueDate])
  @@index([receivableId, status, dueDate])
  @@map("receivable_installments")
}

model PayableTag {
  payableId String @map("payable_id")
  tagId     String @map("tag_id")

  payable Payable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([payableId, tagId])
  @@index([payableId])
  @@index([tagId])
  @@map("payable_tags")
}

model ReceivableTag {
  receivableId String @map("receivable_id")
  tagId        String @map("tag_id")

  receivable Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  tag        Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([receivableId, tagId])
  @@index([receivableId])
  @@index([tagId])
  @@map("receivable_tags")
}

model PayableInstallmentTag {
  payableInstallmentId String @map("payable_installment_id")
  tagId                String @map("tag_id")

  payableInstallment PayableInstallment @relation(fields: [payableInstallmentId], references: [id], onDelete: Cascade)
  tag                Tag                @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([payableInstallmentId, tagId])
  @@index([payableInstallmentId])
  @@index([tagId])
  @@index([tagId, payableInstallmentId])
  @@map("payable_installment_tags")
}

model ReceivableInstallmentTag {
  receivableInstallmentId String @map("receivable_installment_id")
  tagId                   String @map("tag_id")

  receivableInstallment ReceivableInstallment @relation(fields: [receivableInstallmentId], references: [id], onDelete: Cascade)
  tag                   Tag                   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([receivableInstallmentId, tagId])
  @@index([receivableInstallmentId])
  @@index([tagId])
  @@index([tagId, receivableInstallmentId])
  @@map("receivable_installment_tags")
}

model Payment {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  amount         Decimal       @db.Decimal(15, 2)
  paymentDate    DateTime      @map("payment_date")
  paymentMethod  PaymentMethod @map("payment_method")
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  allocations  PaymentAllocation[]

  @@index([organizationId, paymentDate])
  @@map("payments")
}

model PaymentAllocation {
  id                     String  @id @default(uuid())
  paymentId              String  @map("payment_id")
  payableInstallmentId   String? @map("payable_installment_id")
  receivableInstallmentId String? @map("receivable_installment_id")
  amount                 Decimal @db.Decimal(15, 2)

  // Relations
  payment              Payment                @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  payableInstallment   PayableInstallment?    @relation(fields: [payableInstallmentId], references: [id], onDelete: Cascade)
  receivableInstallment ReceivableInstallment? @relation(fields: [receivableInstallmentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([payableInstallmentId])
  @@index([receivableInstallmentId])
  @@map("payment_allocations")
}

model AuditLog {
  id             String      @id @default(uuid())
  organizationId String      @map("organization_id")
  userId         String?     @map("user_id")
  entity         String      // 'payable', 'receivable', 'payment', etc.
  entityId       String      @map("entity_id")
  action         AuditAction
  oldData        Json?       @map("old_data")
  newData        Json?       @map("new_data")
  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
